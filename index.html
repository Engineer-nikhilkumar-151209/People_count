import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, query } from 'firebase/firestore';
import { Users, LogIn, LogOut, Clock, Activity } from 'lucide-react';

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'attendance-system-v1';

export default function App() {
  const [user, setUser] = useState(null);
  const [logs, setLogs] = useState([]);
  const [stats, setStats] = useState({ inRoom: 0, totalEntries: 0, totalExits: 0 });

  useEffect(() => {
    const initAuth = async () => {
      await signInAnonymously(auth);
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;

    // Listen to real-time stats
    const statsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'stats'));
    const unsubStats = onSnapshot(statsQuery, (snapshot) => {
      const data = snapshot.docs[0]?.data();
      if (data) setStats(data);
    }, (error) => console.error("Stats Error:", error));

    // Listen to live logs (monitor.txt sync)
    const logsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'));
    const unsubLogs = onSnapshot(logsQuery, (snapshot) => {
      const logsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sorting by timestamp locally
      logsList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      setLogs(logsList.slice(0, 50)); // Keep last 50
    }, (error) => console.error("Logs Error:", error));

    return () => {
      unsubStats();
      unsubLogs();
    };
  }, [user]);

  if (!user) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-slate-50">
        <div className="animate-pulse text-slate-400">Connecting to secure server...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans p-4 md:p-8">
      {/* Header */}
      <header className="max-w-4xl mx-auto mb-8 flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold tracking-tight text-indigo-600">SmartMonitor</h1>
          <p className="text-sm text-slate-500 flex items-center gap-1">
            <Activity size={14} className="text-green-500" /> System Live
          </p>
        </div>
        <div className="text-right text-xs text-slate-400">
          ID: {appId}<br />
          User: {user.uid.substring(0, 8)}...
        </div>
      </header>

      <main className="max-w-4xl mx-auto space-y-6">
        {/* Stats Grid */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <StatCard 
            title="In Room" 
            value={stats.inRoom} 
            icon={<Users className="text-indigo-500" />} 
            color="bg-indigo-50"
          />
          <StatCard 
            title="Total Entered" 
            value={stats.totalEntries} 
            icon={<LogIn className="text-emerald-500" />} 
            color="bg-emerald-50"
          />
          <StatCard 
            title="Total Exited" 
            value={stats.totalExits} 
            icon={<LogOut className="text-rose-500" />} 
            color="bg-rose-50"
          />
        </div>

        {/* Live Logs Section */}
        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
          <div className="p-4 border-b border-slate-100 flex items-center justify-between">
            <h2 className="font-semibold flex items-center gap-2">
              <Clock size={18} /> Monitor Log (monitor.txt sync)
            </h2>
            <span className="text-xs font-medium px-2 py-1 bg-slate-100 rounded-full text-slate-600">
              Real-time
            </span>
          </div>
          <div className="divide-y divide-slate-50 max-h-[500px] overflow-y-auto">
            {logs.length === 0 ? (
              <div className="p-8 text-center text-slate-400 italic">Waiting for data from webcam...</div>
            ) : (
              logs.map((log) => (
                <div key={log.id} className="p-4 hover:bg-slate-50 transition-colors flex justify-between items-center">
                  <div className="flex flex-col">
                    <span className="font-medium text-slate-800">{log.name}</span>
                    <span className={`text-sm ${log.action.includes('EXIT') ? 'text-rose-500' : 'text-emerald-600'}`}>
                      {log.action}
                    </span>
                  </div>
                  <div className="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded border">
                    {log.timestamp}
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </main>
    </div>
  );
}

function StatCard({ title, value, icon, color }) {
  return (
    <div className={`${color} p-6 rounded-2xl border border-white/50 shadow-sm transition-transform hover:scale-[1.02]`}>
      <div className="flex justify-between items-start mb-2">
        <span className="text-slate-600 font-medium text-sm uppercase tracking-wider">{title}</span>
        <div className="p-2 bg-white rounded-lg shadow-inner">
          {icon}
        </div>
      </div>
      <div className="text-3xl font-bold text-slate-900">{value}</div>
    </div>
  );
}

